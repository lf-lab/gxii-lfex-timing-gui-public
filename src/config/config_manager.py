"""
ч╡▒ф╕АшинхоЪчобчРЖуГвуВ╕уГеуГ╝уГл
хЕиуВвуГЧуГкуВ▒уГ╝уВ╖уГзуГ│шинхоЪуВТщЪОх▒дчЪДуБлчобчРЖ
"""
import json
import yaml
from pathlib import Path
from typing import Any, Dict, Optional, Union, List
import copy
from dataclasses import dataclass, asdict
import warnings


@dataclass
class ValidationRule:
    """шинхоЪхАдуГРуГкуГЗуГ╝уВ╖уГзуГ│уГлуГ╝уГл"""
    type_check: Optional[type] = None
    min_value: Optional[Union[int, float]] = None
    max_value: Optional[Union[int, float]] = None
    allowed_values: Optional[List[Any]] = None
    required: bool = False


class ConfigManager:
    """ч╡▒ф╕АшинхоЪчобчРЖуВпуГйуВ╣"""
    
    def __init__(self, config_dir: Optional[Union[str, Path]] = None):
        """
        ConfigManagerуВТхИЭцЬЯхМЦ
        
        Args:
            config_dir: шинхоЪуГХуВбуВдуГлуГЗуВгуГмуВпуГИуГкуГСуВ╣
        """
        self.config_dir = Path(config_dir) if config_dir else Path(__file__).parent.parent.parent / "config"
        self.config_dir.mkdir(exist_ok=True)
        
        # шинхоЪуГЗуГ╝уВ┐
        self._default_config: Dict = {}
        self._user_config: Dict = {}
        self._current_config: Dict = {}
        
        # уГРуГкуГЗуГ╝уВ╖уГзуГ│уГлуГ╝уГл
        self._validation_rules: Dict[str, ValidationRule] = {}
        
        # шинхоЪуГХуВбуВдуГлуГСуВ╣
        self.default_config_file = self.config_dir / "default.yml"
        self.user_config_file = self.config_dir / "user.yml"
        
        # хИЭцЬЯхМЦ
        self._setup_default_config()
        self._setup_validation_rules()
        self._load_configs()
        self._update_version_from_file()
        
    def _setup_default_config(self):
        """уГЗуГХуВйуГлуГИшинхоЪуВТхоЪч╛й"""
        self._default_config = {
            'app': {
                'name': 'GXII-LFEX Timing Analysis GUI',
                'version': '0.0.0',  # VERSIONуГХуВбуВдуГлуБЛуВЙхЛХчЪДуБлцЫ┤цЦ░уБХуВМуВЛ
                'description': 'GXII-LFEXхоЯщиУуБоуВ┐уВдуГЯуГ│уВ░шзгцЮРGUI',
                'debug_mode': False
            },
            'analysis': {
                'gx_region': {
                    'xmin': 520,
                    'xmax': 600,
                    'ymin': 4,
                    'ymax': 1020
                },
                'lfex_region': {
                    'xmin': 700,
                    'xmax': 800
                },
                'processing': {
                    'noise_threshold': 0.1,
                    'smoothing_window': 5,
                    'prominence': 0.1,
                    'ma_window': 20,
                    'peak_threshold': 0.1
                },
                'peak_detection': {
                    'mode': '2уГФуГ╝уВпцдЬхЗ║',
                    'selection_method': 'цЬАхдзх╝╖х║ж'
                },
                'angle': 0.0
            },
            'time_calibration': {
                'mode': 'хЕих╣ЕцМЗхоЪ',
                'full_width_time': 4.8,
                'pixel_count': 1024,
                'time_per_pixel': 0.004688
            },
            'reference_time': {
                'mode': 'gxii_peak'
            },
            'plot': {
                'figure_size': [12, 8],
                'dpi': 100,
                'line_width': 2,
                'marker_size': 6,
                'colors': {
                    'primary': '#1f77b4',
                    'secondary': '#ff7f0e',
                    'success': '#2ca02c',
                    'warning': '#d62728',
                    'gxii': '#2ca02c',
                    'lfex': '#1f77b4',
                    'peak': '#d62728'
                }
            },
            'files': {
                'supported_formats': ['.txt', '.csv', '.dat', '.img'],
                'output_dir': 'output',
                'temp_dir': 'temp',
                'img_settings': {
                    'default_width': 1024,
                    'default_height': 1024,
                    'default_dtype': 'uint16',
                    'byte_order': 'little'
                }
            },
            'gui': {
                'page_title': 'GXII-LFEX Timing Analysis',
                'page_icon': 'ЁЯФм',
                'layout': 'wide',
                'sidebar_state': 'expanded',
                'port_range': [8501, 8510]
            }
        }
        
    def _setup_validation_rules(self):
        """уГРуГкуГЗуГ╝уВ╖уГзуГ│уГлуГ╝уГлуВТшинхоЪ"""
        self._validation_rules = {
            'analysis.gx_region.xmin': ValidationRule(type_check=int, min_value=0, max_value=2048),
            'analysis.gx_region.xmax': ValidationRule(type_check=int, min_value=0, max_value=2048),
            'analysis.gx_region.ymin': ValidationRule(type_check=int, min_value=0, max_value=2048),
            'analysis.gx_region.ymax': ValidationRule(type_check=int, min_value=0, max_value=2048),
            'analysis.lfex_region.xmin': ValidationRule(type_check=int, min_value=0, max_value=2048),
            'analysis.lfex_region.xmax': ValidationRule(type_check=int, min_value=0, max_value=2048),
            'analysis.processing.noise_threshold': ValidationRule(type_check=float, min_value=0.0, max_value=1.0),
            'analysis.processing.smoothing_window': ValidationRule(type_check=int, min_value=1, max_value=100),
            'analysis.processing.ma_window': ValidationRule(type_check=int, min_value=1, max_value=100),
            'analysis.processing.peak_threshold': ValidationRule(type_check=float, min_value=0.0, max_value=1.0),
            'analysis.peak_detection.mode': ValidationRule(type_check=str, allowed_values=['2уГФуГ╝уВпцдЬхЗ║', '1уГФуГ╝уВпцдЬхЗ║']),
            'analysis.peak_detection.selection_method': ValidationRule(type_check=str, allowed_values=['цЬАхдзх╝╖х║ж', 'цЬАхИЭуБоуГФуГ╝уВп', 'цЬАх╛МуБоуГФуГ╝уВп']),
            'analysis.angle': ValidationRule(type_check=float, min_value=-45.0, max_value=45.0),
            'time_calibration.mode': ValidationRule(type_check=str, allowed_values=['хЕих╣ЕцМЗхоЪ', '1pixelцМЗхоЪ', 'уГХуВгуГГуГЖуВгуГ│уВ░']),
            'time_calibration.full_width_time': ValidationRule(type_check=float, min_value=0.1, max_value=100.0),
            'time_calibration.time_per_pixel': ValidationRule(type_check=float, min_value=0.001, max_value=1.0),
            'reference_time.mode': ValidationRule(type_check=str, allowed_values=['gxii_peak', 'streak_time', 'gxii_rise', 'absolute', 'manual', 'custom_t0', 'lfex_peak']),
            'plot.figure_size': ValidationRule(type_check=list),
            'plot.dpi': ValidationRule(type_check=int, min_value=50, max_value=300),
        }
    
    def _load_configs(self):
        """шинхоЪуГХуВбуВдуГлуВТшкнуБ┐ш╛╝уБ┐"""
        # уГЗуГХуВйуГлуГИшинхоЪуГХуВбуВдуГлуБоф╜ЬцИР/шкнуБ┐ш╛╝уБ┐
        if not self.default_config_file.exists():
            self._save_config_file(self.default_config_file, self._default_config)
        else:
            try:
                self._default_config = self._load_config_file(self.default_config_file)
            except Exception as e:
                warnings.warn(f"уГЗуГХуВйуГлуГИшинхоЪшкнуБ┐ш╛╝уБ┐хд▒цХЧ: {e}")
        
        # уГжуГ╝уВ╢уГ╝шинхоЪуГХуВбуВдуГлуБошкнуБ┐ш╛╝уБ┐
        if self.user_config_file.exists():
            try:
                self._user_config = self._load_config_file(self.user_config_file)
            except Exception as e:
                warnings.warn(f"уГжуГ╝уВ╢уГ╝шинхоЪшкнуБ┐ш╛╝уБ┐хд▒цХЧ: {e}")
                self._user_config = {}
        
        # чП╛хЬиуБошинхоЪуВТч╡▒хРИ
        self._merge_configs()
    
    def _load_config_file(self, filepath: Path) -> Dict:
        """шинхоЪуГХуВбуВдуГлуВТшкнуБ┐ш╛╝уБ┐"""
        with open(filepath, 'r', encoding='utf-8') as f:
            if filepath.suffix in ['.yml', '.yaml']:
                return yaml.safe_load(f) or {}
            elif filepath.suffix == '.json':
                return json.load(f)
            else:
                raise ValueError(f"уВ╡уГЭуГ╝уГИуБХуВМуБжуБДуБкуБДшинхоЪуГХуВбуВдуГлх╜вх╝П: {filepath.suffix}")
    
    def _save_config_file(self, filepath: Path, config: Dict):
        """шинхоЪуГХуВбуВдуГлуВТф┐ЭхнШ"""
        filepath.parent.mkdir(parents=True, exist_ok=True)
        with open(filepath, 'w', encoding='utf-8') as f:
            if filepath.suffix in ['.yml', '.yaml']:
                yaml.dump(config, f, default_flow_style=False, allow_unicode=True, indent=2)
            elif filepath.suffix == '.json':
                json.dump(config, f, indent=2, ensure_ascii=False)
    
    def _merge_configs(self):
        """уГЗуГХуВйуГлуГИшинхоЪуБиуГжуГ╝уВ╢уГ╝шинхоЪуВТч╡▒хРИ"""
        self._current_config = copy.deepcopy(self._default_config)
        self._deep_merge(self._current_config, self._user_config)
    
    def _deep_merge(self, base: Dict, override: Dict):
        """ш╛ЮцЫ╕уВТц╖▒уБПуГЮуГ╝уВ╕"""
        for key, value in override.items():
            if key in base and isinstance(base[key], dict) and isinstance(value, dict):
                self._deep_merge(base[key], value)
            else:
                base[key] = value
    
    def get(self, key: str, default: Any = None) -> Any:
        """
        щЪОх▒дуВнуГ╝уБзшинхоЪхАдуВТхПЦх╛Ч
        
        Args:
            key: щЪОх▒дуВнуГ╝ (ф╛Л: 'analysis.gx_region.xmin')
            default: уГЗуГХуВйуГлуГИхАд
            
        Returns:
            шинхоЪхАд
        """
        keys = key.split('.')
        current = self._current_config
        
        try:
            for k in keys:
                current = current[k]
            return current
        except (KeyError, TypeError):
            return default
    
    def set(self, key: str, value: Any, save_user_config: bool = True) -> bool:
        """
        щЪОх▒дуВнуГ╝уБзшинхоЪхАдуВТшинхоЪ
        
        Args:
            key: щЪОх▒дуВнуГ╝
            value: шинхоЪхАд
            save_user_config: уГжуГ╝уВ╢уГ╝шинхоЪуБиуБЧуБжф┐ЭхнШуБЩуВЛуБЛ
            
        Returns:
            шинхоЪцИРхКЯуГХуГйуВ░
        """
        # уГРуГкуГЗуГ╝уВ╖уГзуГ│
        if not self._validate_value(key, value):
            return False
        
        # чП╛хЬиуБошинхоЪуВТцЫ┤цЦ░
        keys = key.split('.')
        current = self._current_config
        
        for k in keys[:-1]:
            if k not in current:
                current[k] = {}
            current = current[k]
        
        current[keys[-1]] = value
        
        # уГжуГ╝уВ╢уГ╝шинхоЪуВТцЫ┤цЦ░
        if save_user_config:
            user_current = self._user_config
            for k in keys[:-1]:
                if k not in user_current:
                    user_current[k] = {}
                user_current = user_current[k]
            user_current[keys[-1]] = value
            
            # уГжуГ╝уВ╢уГ╝шинхоЪуГХуВбуВдуГлуБлф┐ЭхнШ
            self.save_user_config()
        
        return True
    
    def _validate_value(self, key: str, value: Any) -> bool:
        """шинхоЪхАдуВТуГРуГкуГЗуГ╝уВ╖уГзуГ│"""
        if key not in self._validation_rules:
            return True  # уГлуГ╝уГлуБМуБкуБДха┤хРИуБпщАЪуБЩ
        
        rule = self._validation_rules[key]
        
        # хЮЛуГБуВзуГГуВп
        if rule.type_check and not isinstance(value, rule.type_check):
            warnings.warn(f"шинхоЪхАдуБохЮЛуБМф╕НцнгуБзуБЩ: {key} = {value} (цЬЯх╛ЕхЮЛ: {rule.type_check.__name__})")
            return False
        
        # чпДхЫ▓уГБуВзуГГуВп
        if rule.min_value is not None and hasattr(value, '__lt__') and value < rule.min_value:
            warnings.warn(f"шинхоЪхАдуБМцЬАх░ПхАдуВТф╕ЛхЫЮуБгуБжуБДуБ╛уБЩ: {key} = {value} (цЬАх░ПхАд: {rule.min_value})")
            return False
            
        if rule.max_value is not None and hasattr(value, '__gt__') and value > rule.max_value:
            warnings.warn(f"шинхоЪхАдуБМцЬАхдзхАдуВТф╕КхЫЮуБгуБжуБДуБ╛уБЩ: {key} = {value} (цЬАхдзхАд: {rule.max_value})")
            return False
        
        # ши▒хПпхАдуГБуВзуГГуВп
        if rule.allowed_values and value not in rule.allowed_values:
            warnings.warn(f"шинхоЪхАдуБМши▒хПпхАдуГкуВ╣уГИуБлуБВуВКуБ╛уБЫуВУ: {key} = {value} (ши▒хПпхАд: {rule.allowed_values})")
            return False
        
        return True
    
    def save_user_config(self):
        """уГжуГ╝уВ╢уГ╝шинхоЪуВТф┐ЭхнШ"""
        self._save_config_file(self.user_config_file, self._user_config)
    
    def reset_user_config(self):
        """уГжуГ╝уВ╢уГ╝шинхоЪуВТуГкуВ╗уГГуГИ"""
        self._user_config = {}
        if self.user_config_file.exists():
            self.user_config_file.unlink()
        self._merge_configs()
    
    def load_preset(self, preset_name: str) -> bool:
        """уГЧуГкуВ╗уГГуГИшинхоЪуВТшкнуБ┐ш╛╝уБ┐"""
        preset_file = self.config_dir / "presets" / f"{preset_name}.yml"
        if not preset_file.exists():
            warnings.warn(f"уГЧуГкуВ╗уГГуГИуГХуВбуВдуГлуБМшжЛуБдуБЛуВКуБ╛уБЫуВУ: {preset_file}")
            return False
        
        try:
            preset_config = self._load_config_file(preset_file)
            self._user_config.update(preset_config)
            self._merge_configs()
            self.save_user_config()
            return True
        except Exception as e:
            warnings.warn(f"уГЧуГкуВ╗уГГуГИшкнуБ┐ш╛╝уБ┐хд▒цХЧ: {e}")
            return False
    
    def save_preset(self, preset_name: str, config_subset: Optional[Dict] = None) -> bool:
        """чП╛хЬиуБошинхоЪуВТуГЧуГкуВ╗уГГуГИуБиуБЧуБжф┐ЭхнШ"""
        preset_dir = self.config_dir / "presets"
        preset_dir.mkdir(exist_ok=True)
        preset_file = preset_dir / f"{preset_name}.yml"
        
        try:
            save_config = config_subset if config_subset else self._user_config
            self._save_config_file(preset_file, save_config)
            return True
        except Exception as e:
            warnings.warn(f"уГЧуГкуВ╗уГГуГИф┐ЭхнШхд▒цХЧ: {e}")
            return False
    
    def list_presets(self) -> List[str]:
        """хИйчФихПпшГ╜уБкуГЧуГкуВ╗уГГуГИф╕АшжзуВТхПЦх╛Ч"""
        preset_dir = self.config_dir / "presets"
        if not preset_dir.exists():
            return []
        
        presets = []
        for preset_file in preset_dir.glob("*.yml"):
            presets.append(preset_file.stem)
        return sorted(presets)
    
    def get_all_settings(self) -> Dict:
        """хЕишинхоЪуВТхПЦх╛Ч"""
        return copy.deepcopy(self._current_config)
    
    def get_user_settings(self) -> Dict:
        """уГжуГ╝уВ╢уГ╝шинхоЪуБоуБ┐уВТхПЦх╛Ч"""
        return copy.deepcopy(self._user_config)
    
    def export_settings(self, filepath: Union[str, Path], format: str = 'yaml') -> bool:
        """шинхоЪуВТуГХуВбуВдуГлуБлуВиуВпуВ╣уГЭуГ╝уГИ"""
        try:
            export_path = Path(filepath)
            if format.lower() == 'yaml':
                export_path = export_path.with_suffix('.yml')
            elif format.lower() == 'json':
                export_path = export_path.with_suffix('.json')
            
            self._save_config_file(export_path, self._current_config)
            return True
        except Exception as e:
            warnings.warn(f"шинхоЪуВиуВпуВ╣уГЭуГ╝уГИхд▒цХЧ: {e}")
            return False
    
    def _update_version_from_file(self):
        """уГлуГ╝уГИуБоVERSIONуГХуВбуВдуГлуБЛуВЙуГРуГ╝уВ╕уГзуГ│уВТшкнуБ┐хПЦуБгуБжцЫ┤цЦ░"""
        try:
            # уГЧуГнуВ╕уВзуВпуГИуГлуГ╝уГИуБоVERSIONуГХуВбуВдуГлуГСуВ╣
            version_file = self.config_dir.parent / "VERSION"
            
            if version_file.exists():
                with open(version_file, 'r', encoding='utf-8') as f:
                    version = f.read().strip()
                
                # чП╛хЬиуБошинхоЪуБлуГРуГ╝уВ╕уГзуГ│уВТцЫ┤цЦ░
                if 'app' not in self._current_config:
                    self._current_config['app'] = {}
                self._current_config['app']['version'] = version
                
                # уГЗуГХуВйуГлуГИшинхоЪуВВцЫ┤цЦ░
                if 'app' not in self._default_config:
                    self._default_config['app'] = {}
                self._default_config['app']['version'] = version
                
                # default.ymlуГХуВбуВдуГлуВВцЫ┤цЦ░
                self._save_config_file(self.default_config_file, self._default_config)
                
        except Exception as e:
            warnings.warn(f"VERSIONуГХуВбуВдуГлшкнуБ┐ш╛╝уБ┐хд▒цХЧ: {e}")


# уВ░уГнуГ╝уГРуГлConfigManagerуВдуГ│уВ╣уВ┐уГ│уВ╣
config_manager = ConfigManager()
